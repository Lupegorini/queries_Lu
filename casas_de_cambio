--- Identificação de possíveis CASAS DE CÂMBIO ---

SELECT DISTINCT 
b.MERCHANT_CODE_C,
dm.MERCHANT_ID,
pv.BUSINESS_NAME,
b.MCC_CODE_C,
dm.MCC_NATURE_PURPOSE,
b.LEGAL_TYPE_C,
pv.TAX_ID,
a.SIGN_UP_DATE_TIME_C::date AS "SIGN_UP_DATE",
st.ACCOUNT_STATUS,
st.ACCOUNT_SUBSTATUS,
tx.DATE_LAST_SUCCESS_TX,
CASE
	WHEN tx.DATE_LAST_SUCCESS_TX <= '2024.03.01' THEN 'Inactive'
	WHEN tx.DATE_LAST_SUCCESS_TX >= '2024.03.01' THEN 'Active'
	ELSE 'no_TX'
END AS SOAP_Activity,
la.LAST_TX_OUT_AT,
CASE 
	WHEN la.LAST_TX_OUT_AT <= '2024.03.01' THEN 'Inactive'
	WHEN la.LAST_TX_OUT_AT >= '2024.03.01' THEN 'Active'
	ELSE 'no_BKO'
END AS BKO_Activity,
from SUMUP_DWH_PROD.SRC_SALESFORCE.contact a
left join SUMUP_DWH_PROD.SRC_SALESFORCE."ACCOUNT" b ON b.id = a.ACCOUNT_ID
LEFT JOIN SUMUP_DWH_PROD.OLAP.V_M_DIM_MERCHANT_PRIVATE pv ON b.EMAIL_C = pv.EMAIL
LEFT JOIN SUMUP_DWH_PROD.olap.V_M_DIM_ACCOUNT_STATUS st ON pv.DIM_MERCHANT_ID = st.DIM_MERCHANT_ID
LEFT JOIN SUMUP_DWH_PROD.SRC_PAYMENT.PERSONAL_DETAILS c ON pv.NATIONAL_ID = c.NATIONAL_ID
LEFT JOIN SUMUP_DWH_PROD.OLAP.V_M_DIM_MERCHANT dm ON b.MERCHANT_CODE_C = dm.MERCHANT_CODE
left JOIN SUMUP_DWH_PROD.OLAP.V_M_FACTS_TRANSACTION TX ON TX.DIM_MERCHANT_ID = DM.DIM_MERCHANT_ID
left join SUMUP_DWH_PROD.SRC_RISK_AND_COMPLIANCE.AML_RISK_LEVEL_5_TIER_EXTENDED hr on hr.merchant_code = DM.MERCHANT_CODE --aml score
LEFT JOIN SUMUP_DWH_PROD.MART_MERCHANT_BANK.V_M_DIM_MERCHANTS_LATAM la ON dm.MERCHANT_CODE = la.MERCHANT_CODE  --- dados de BKO
WHERE 1=1
AND b.COUNTRY_C = 'Brazil'
AND st.ACCOUNT_STATUS = 'ACTIVE'
AND (b.MCC_CODE_C IN ('6051')
OR ((dm.MCC_NATURE_PURPOSE ilike '%CAMBIO%' OR
dm.MCC_NATURE_PURPOSE ilike '%Câmbio%' OR
dm.MCC_NATURE_PURPOSE ilike '%casa de câmbio%' OR
dm.MCC_NATURE_PURPOSE ilike '%Agência de câmbio%' OR
dm.MCC_NATURE_PURPOSE ilike '%Agência de câmbio%' OR
dm.MCC_NATURE_PURPOSE ilike '%Posto de câmbio%' OR
dm.MCC_NATURE_PURPOSE ilike '%conversão de moeda%' OR
dm.MCC_NATURE_PURPOSE ilike '%Operadora de câmbio%')
OR (pv.BUSINESS_NAME ilike '%Posto de câmbio%' OR
pv.business_name ilike '%Câmbio%' OR
pv.BUSINESS_NAME ilike '%casa de câmbio%' OR
pv.BUSINESS_NAME ilike '%Agência de câmbio%' OR
pv.BUSINESS_NAME ilike '%Agência de câmbio%' OR
pv.BUSINESS_NAME ilike '%Posto de câmbio%' OR
pv.BUSINESS_NAME ilike '%conversão de moeda%' OR
pv.BUSINESS_NAME ilike '%Operadora de câmbio%')
AND (dm.MCC_NATURE_PURPOSE NOT LIKE '%mecanico%' and
dm.MCC_NATURE_PURPOSE NOT LIKE '%mecanica%' and
dm.MCC_NATURE_PURPOSE NOT LIKE '%oficina%' and
dm.MCC_NATURE_PURPOSE NOT LIKE '%MOTOR%')))
