--------- IDENTIFICAÇÃO DE CADASTROS LOW/MEDIUM QUE DEVERIAM SER HIGH RISK ---------
SELECT distinct
m.MERCHANT_CODE,
m.MERCHANT_ID,
m.CATEGORY_CODE AS MCC_CODE,
m.CATEGORY_NAME AS description,
vmd.MCC_NATURE_PURPOSE,
m.LEGAL_TYPE_NAME AS legal_type,
gl.MERCHANT_SIGN_UP_AT::date AS signup_date,
EXTRACT(WEEK FROM gl.MERCHANT_SIGN_UP_AT) AS SIGNUP_WEEK,
hr.AML_RISK_LEVEL,
FROM GLOBAL_ANALYST_PROD.MART_MERCHANT.MERCHANTS M
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS MC ON M.MERCHANT_CODE = MC.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.OLAP.V_M_DIM_MERCHANT VMD ON VMD.MERCHANT_CODE = M.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE."ACCOUNT" ac ON m.MERCHANT_CODE = ac.MERCHANT_CODE_C
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE.contact a ON ac.id = a.ACCOUNT_ID
LEFT JOIN SUMUP_DWH_PROD.SRC_RISK_AND_COMPLIANCE.AML_RISK_LEVEL_5_TIER_EXTENDED hr ON m.MERCHANT_CODE = hr.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.MART_MERCHANT_BANK.V_M_DIM_MERCHANTS_LATAM la ON m.merchant_code = la.MERCHANT_CODE
LEFT JOIN global_analyst_prod.mart_growth.verification_merchant_verification_status gl ON m.merchant_code = gl.MERCHANT_CODE
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS ip ON m.MERCHANT_CODE = ip.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.src_payment.merchants m2 ON GL.MERCHANT_CODE = M2.MERCHANT_CODE 
WHERE 1=1
    AND ac.COUNTRY_C = 'Brazil'
    AND m.CATEGORY_CODE IN ('9399','7631','5932','5971','7995','8398','5169','8641','7273',
    '6011','6012','6051','5983','5541','8699','5172','8651','5094','8661','5935','6211','5972')
    AND hr.AML_RISK_LEVEL NOT IN ('HIGH')
    AND gl.MERCHANT_SIGN_UP_AT >= '2024-01-01'
    QUALIFY ROW_NUMBER() OVER (PARTITION BY m.MERCHANT_ID ORDER BY hr.aml_risk_score_date desc) = 1
