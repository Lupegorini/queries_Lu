------- DADOS VIRP -------


SELECT distinct
m.MERCHANT_CODE,
m.MERCHANT_ID,
m.CATEGORY_CODE AS MCC_CODE,
m.CATEGORY_NAME AS description,
ac.NAME AS business_name,
vmd.MCC_NATURE_PURPOSE,
m.LEGAL_TYPE_NAME AS legal_type,
gl.MERCHANT_SIGN_UP_AT::date AS signup_date,
a.MERCHANT_CLASSIFICATION_C,
hr.AML_RISK_LEVEL,
ip.LIFETIME_SUCCESSFUL_TRANSACTION_COUNT,
ip.LIFETIME_TPV_AMOUNT_LC,
CASE 
	WHEN ip.LAST_SUCCESSFUL_TRANSACTION_AT <= '2024-07-01' THEN 'INACTIVE'
	WHEN ip.LAST_SUCCESSFUL_TRANSACTION_AT > '2024-07-01' THEN 'ACTIVE'
	ELSE 'NO_TX'
END AS ACTIVE_SOAP,
CASE
	WHEN la.LAST_TX_OUT_AT <= '2024-07-01' THEN 'INACTIVE'
	WHEN la.LAST_TX_OUT_AT > '2024-07-01' THEN 'ACTIVE'
	ELSE 'NO_BKO'
END AS ACTIVE_BKO,
FROM GLOBAL_ANALYST_PROD.MART_MERCHANT.MERCHANTS M
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS MC ON M.MERCHANT_CODE = MC.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.OLAP.V_M_DIM_MERCHANT VMD ON VMD.MERCHANT_CODE = M.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE."ACCOUNT" ac ON m.MERCHANT_CODE = ac.MERCHANT_CODE_C
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE.contact a ON ac.id = a.ACCOUNT_ID
LEFT JOIN SUMUP_DWH_PROD.SRC_RISK_AND_COMPLIANCE.AML_RISK_LEVEL_5_TIER_EXTENDED hr ON m.MERCHANT_CODE = hr.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.MART_MERCHANT_BANK.V_M_DIM_MERCHANTS_LATAM la ON m.merchant_code = la.MERCHANT_CODE
LEFT JOIN global_analyst_prod.mart_growth.verification_merchant_verification_status gl ON m.merchant_code = gl.MERCHANT_CODE
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS ip ON m.MERCHANT_CODE = ip.MERCHANT_CODE
WHERE 1=1
    AND ac.COUNTRY_C = 'Brazil'
    AND gl.MERCHANT_ACCOUNT_STATE = 'active'
    AND m.CATEGORY_CODE IN ('4816')
QUALIFY ROW_NUMBER() OVER (PARTITION BY m.merchant_code ORDER BY a.UPDATED_AT desc) = 1  

    
    

    
    
    ----------- VIRP CLOSED REASON ----------    
    
  SELECT DISTINCT
kl.MERCHANT_ID,
m.MERCHANT_CODE,
ac.MCC_CODE_C AS current_mcc,
ac.MCC_LEVEL_C AS description,
ac.NAME AS business_name,
VMD.MCC_NATURE_PURPOSE,
gl.MERCHANT_ACCOUNT_STATE,
gl.MERCHANT_ACCOUNT_SUBSTATE,
kl.comment AS CLOSED_COMMENT,
CASE
	WHEN kl.comment iLIKE '%#re-KYC%' THEN 're-KYC' 
	WHEN kl.comment iLIKE '%re-KYC%' THEN 're-KYC'
	WHEN kl.comment iLIKE '%#reKYC%' THEN 're-KYC'
	WHEN kl.comment iLIKE '%#onb30dias%' THEN 'Ação_30_dias'
	WHEN kl.comment iLIKE '%30 dias%' THEN 'Ação_30_dias'	
	WHEN kl.comment iLIKE '%#KYCrefreshBR%' THEN 'KYC Refresh'	
	WHEN kl.comment iLIKE '%#KYC: fechado por%' THEN 'Falha_KYC'
	WHEN kl.comment iLIKE '%FRD%' THEN 'Fraud_Prevention'
	WHEN kl.comment iLIKE '%PREV%' THEN 'Fraud_Prevention'
	WHEN kl.comment iLIKE '%suspicious%' THEN 'Fraud_Prevention'
	WHEN kl.comment iLIKE '%FRD%' THEN 'Fraud_Prevention'
	WHEN kl.comment iLIKE '%requested%' THEN 'Solicitação'
	WHEN kl.comment iLIKE '%solicita%' THEN 'Solicitação'
	WHEN kl.comment iLIKE '%solicitou%' THEN 'Solicitação'
	WHEN kl.comment iLIKE '%a pedido%' THEN 'Solicitação'
	ELSE 'Não identificado'
END AS CLOSED_REASON
FROM GLOBAL_ANALYST_PROD.MART_MERCHANT.MERCHANTS M
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS MC ON M.MERCHANT_CODE = MC.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.OLAP.V_M_DIM_MERCHANT VMD ON VMD.MERCHANT_CODE = M.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE."ACCOUNT" ac ON m.MERCHANT_CODE = ac.MERCHANT_CODE_C
LEFT JOIN SUMUP_DWH_PROD.SRC_SALESFORCE.contact a ON ac.id = a.ACCOUNT_ID
LEFT JOIN SUMUP_DWH_PROD.SRC_RISK_AND_COMPLIANCE.AML_RISK_LEVEL_5_TIER_EXTENDED hr ON m.MERCHANT_CODE = hr.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.MART_MERCHANT_BANK.V_M_DIM_MERCHANTS_LATAM la ON m.merchant_code = la.MERCHANT_CODE
LEFT JOIN global_analyst_prod.mart_growth.verification_merchant_verification_status gl ON m.merchant_code = gl.MERCHANT_CODE
LEFT JOIN GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS ip ON m.MERCHANT_CODE = ip.MERCHANT_CODE
LEFT JOIN SUMUP_DWH_PROD.src_payment.merchants m2 ON GL.MERCHANT_CODE = M2.MERCHANT_CODE 
LEFT JOIN SUMUP_DWH_PROD.src_payment.kyc_logs kl ON kl.merchant_id = m2.id
LEFT JOIN SUMUP_DWH_PROD.src_payment.kyc_actions ka ON ka.id = kl.kyc_action_id
LEFT JOIN SUMUP_DWH_PROD.src_payment.kyc_action_statuses kas ON kas.id = kl.kyc_action_status_id
LEFT JOIN SUMUP_DWH_PROD.src_payment.superusers su ON su.id = kl.operator_id
left join SUMUP_DWH_PROD.ANALYST_OPERATIONS.OPS_SCHEDULE sch on sch.agent = su.email and sch.date = kl.action_time::date
left join SUMUP_DWH_PROD.analyst_risk_and_fraud.teams_2 t2 on t2.email = su.email
WHERE 1=1
AND gl.MERCHANT_ACCOUNT_STATE = 'closed'
AND ac.COUNTRY_C = 'Brazil'
AND kas.id in ('35')
AND (kl.comment not LIKE '%irreversível%' AND
kl.comment not LIKE '%desinteresse%' AND
kl.comment not LIKE '%KYC: fechado por CPF inexistente%' AND
kl.comment not LIKE '%CPF inexistente%' AND
kl.comment not LIKE '%Duplicado%' AND
kl.comment not LIKE '%KYC: similar fechado por Risco - irreversível%' AND
kl.comment not LIKE '%KYC: fechado por desinteresse comercial%' AND
kl.comment not LIKE '%KYC: fechado por Score negativo Unico%' AND
kl.comment not LIKE '%KYC: fechado por óbito do titular%')
AND su.EMAIL NOT LIKE 'NULL'
AND ac.MCC_CODE_C IN ('5967','7273','7995','5122','5912','6051','6012','4816','5816','6211','5966','5968','5993')
QUALIFY ROW_NUMBER() OVER (PARTITION BY kl.MERCHANT_ID ORDER BY kl.action_time desc) = 1  
    
    
    
    
    SELECT*
    FROM GLOBAL_ANALYST_PROD.MART_CORE.PAYMENTS_MERCHANT_METRICS
    LIMIT 6
    
    
    
    ------------ balanço de SUMUP BANK -----------------
   
    
    SELECT*
	FROM SUMUP_DWH_PROD.MART_MERCHANT_BANK.V_M_DIM_MERCHANT_DAILY_BALANCE_LATAM  eod
	left join GLOBAL_BANK_PROD.MART_GLOBAL_BANK.V_MART_ACCOUNT__LATAM_ACCOUNTS acc on acc.merchant_code = eod.merchant_code
    left JOIN MART_MERCHANT_BANK.A_DIM_LEDGER_ACCOUNTS_BR LE ON acc.LEDGER_ACCOUNT_ID = LE.ID
			WHERE "DATE" = CURRENT_DATE() - 1
            and acc.current_flag = 1
            and eod.merchant_code in ('MEYP7TZU')
            
            
SELECT
gl.MERCHANT_CODE
FROM global_analyst_prod.mart_growth.verification_merchant_verification_status gl --ON mp.merchant_id = gl.MERCHANT_ID 
WHERE gl.merchant_code = 'M2AU74TC'
